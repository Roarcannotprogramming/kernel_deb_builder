name: Build kernel deb packages
on:
  workflow_dispatch:
  push:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        version: ["5.10.5", "5.10.10", "5.10.15", "5.10.20", "5.10.25", "5.10.30", "5.10.35", "5.10.40", "5.10.45", "5.10.50", "5.10.55"]
    name: Build kernel
    runs-on: ubuntu-22.04
    steps:
      - name: Update and Upgrade
        run: |
          sudo apt-get update
          sudo apt-get upgrade -y
          sudo apt install zstd tree -y
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 4096
          swap-size-mb: 512
          remove-dotnet: 'true'
          remove-android: 'true'

      - name: Checkout
        uses: actions/checkout@v3

      - name: start docker and build 
        run: |
          ls -al ${{ github.workspace }} 
          chmod +x ${{ github.workspace }}/docker-entrypoint.sh 
          docker run --rm --user root --env VERSION=${{ matrix.version }} \
            -v ${{ github.workspace }}/linux-${{ matrix.version }}/:/linux-${{ matrix.version }}/ \
            -v ${{ github.workspace }}/config-${{ matrix.version }}:/config-${{ matrix.version }} \
            -v ${{ github.workspace }}/docker-entrypoint.sh:/docker-entrypoint.sh \
            -v ${{ github.workspace }}/patch.d/:/patch.d/ \
            gcc:bullseye "/docker-entrypoint.sh"

      - name: prepare artifact
        run: |
          cd ${{ github.workspace }}
          sudo du -h --max-depth=1
          tree .
          VMLINUX_PATH="$(find . -name *vmlinux)"
          BZIMAGE_PATH="$(find . -name *bzImage)"
          KO_PATH="$(find . -name *.ko)"
          CONFIG_PATH="$(find . -name *.config)"
          tar -cvf - $VMLINUX_PATH $BZIMAGE_PATH $KO_PATH $CONFIG_PATH | zstd - -o linux-${{ matrix.version }}.tar.zst 

      - name: Artifact
        uses: actions/upload-artifact@v3
        with:
          name: linux-${{ matrix.version }}
          path: ${{ github.workspace }}/linux-${{ matrix.version }}.tar.zst